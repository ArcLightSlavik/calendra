Re-implement the logic of replace.